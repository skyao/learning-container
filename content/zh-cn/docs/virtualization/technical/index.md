---
title: "虚拟化技术"
linkTitle: "技术"
weight: 20
date: 2025-04-30
description: >
  虚拟化技术介绍
---


虚拟化为我们想要虚拟化的实际资源提供了抽象。应用这种抽象的级别会改变不同虚拟化技术的外观。

## 虚拟化技术分类

- Virtual machine (VM)-based / 基于虚拟机

- Container-based / 基于容器

- unikernel： 轻量级的单一用途 VM， 包含 Nabla 等项目


### 基于虚拟机的虚拟化

基于虚拟机的方法将整个操作系统虚拟化。

它提供给 VM 的抽象是虚拟设备,如虚拟磁盘、虚拟 CPU 和虚拟 NIC。换句话说,我们可以说这是对整个 ISA(指令集架构)的虚拟化;例如,x86 ISA.

借助虚拟机,多个作系统可以共享相同的硬件资源,并虚拟化表示 VM 可用的每个资源。

VM 执行在硬件隔离的虚拟地址空间中,并且权限级别低于主机作系统。 进程和 VM 之间的主要区别在于主机向 VM 公开的 ABI(应用程序二进制接口)：

- 对于进程,公开的 ABI 具有网络套接字、FD 等结构

- 对于成熟的操作系统虚拟化, ABI 将具有虚拟磁盘、虚拟 CPU、虚拟网卡等结构。

### 基于容器的虚拟化

基于容器的虚拟化并不抽象化硬件,而是使用 Linux 内核中的技术来隔离不同资源的访问路径。

在同一作系统中划出一个逻辑边界。例如,我们得到一个单独的根文件系统、一个单独的进程树、一个单独的网络子系统,等等。

## Hypervisor

Hypervisor 是一个特殊的软件用于虚拟化作系统。

Hypervisor 有两个部分：

1. 虚拟机监视器 (Virtual Machine Monitor / VMM): 用于捕获和模拟特权指令集(只有作系统的内核才能执行)

2. 设备型号（Device model）: 用于虚拟化 I/O 设备。

### 虚拟机监视器/VMM

由于硬件不能直接在虚拟机上获得(尽管在某些情况下可以，比如硬件直通),因此 VMM 会捕获访问硬件(如磁盘/网卡)的特权指令,并代表虚拟机执行这些指令。

VMM 必须满足三个属性：

1. 隔离（Isolation）: 应将 guest (VM) 彼此隔离。
2. 等效性（Equivalency）: 无论是否虚拟化,行为都应该相同。这意味着我们在物理硬件上运行大部分(几乎全部)指令,无需任何转换,依此类推。
3. 性能（Performance）: 性能应该与没有任何虚拟化时一样好。这再次意味着运行 VM 的开销最小。

VMM 的一些常见功能如下:

- 不允许 VM 访问特权状态： 也就是说,不应允许从 VM 执行作某些主机寄存器的状态之类的作。VMM 将始终捕获和模拟这些调用。

- 处理异常和中断。如果网络调用(即请求)是从虚拟机中发出的,则它将被困在 VMM 中并进行模拟。 在通过物理网络/NIC 收到响应后,CPU 将生成一个中断并将其传送到它所寻址的实际虚拟机。

- 通过在本地(在 VM 的虚拟 CPU 内)运行大多数指令并仅捕获某些特权指令来处理 CPU 虚拟化。这意味着其性能几乎与直接在硬件上运行的本机代码一样好。

- 通过将对 Guest 中虚拟设备映射内存的调用映射到实际的物理设备映射内存来处理内存映射 I/O。为此,VMM 应控制物理内存映射(来宾物理内存到主机物理内存)

### 设备型号

设备型号是 VMM 的一部分,用于模拟硬件设备。

虚拟机管理程序的设备模型通过捕获和模拟,然后将中断传递回特定虚拟机来再次处理 I/O 虚拟化。


